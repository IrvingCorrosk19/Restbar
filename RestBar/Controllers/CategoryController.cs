using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using RestBar.Models;
using RestBar.Services;
using System;
using System.Threading.Tasks;
using System.Linq;
using RestBar.Interfaces;
using System.Security.Claims;

namespace RestBar.Controllers
{
    [Authorize(Policy = "SystemConfig")]
    public class CategoryController : Controller
    {
        private readonly ICategoryService _categoryService;
        private readonly IProductService _productService;
        private readonly IAreaService _areaService;
        private readonly ICompanyService _companyService;
        private readonly IBranchService _branchService;

        public CategoryController(ICategoryService categoryService, IProductService productService, 
            IAreaService areaService, ICompanyService companyService, IBranchService branchService)
        {
            _categoryService = categoryService;
            _productService = productService;
            _areaService = areaService;
            _companyService = companyService;
            _branchService = branchService;
        }

        public async Task<IActionResult> Index()
        {
            var categories = await _categoryService.GetAllCategoriesAsync();
            return View(categories);
        }

        [HttpGet]
        public IActionResult Create()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Create(Category category)
        {
            try
            {
                Console.WriteLine("üîç [CategoryController] Create() - Iniciando creaci√≥n de categor√≠a...");
                
                if (ModelState.IsValid)
                {
                    // Obtener usuario actual y asignar CompanyId y BranchId
                    var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);
                    if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out Guid userId))
                    {
                        var currentUser = await _areaService.GetCurrentUserWithAssignmentsAsync(userId);
                        if (currentUser != null)
                        {
                            category.CompanyId = currentUser.CompanyId;
                            category.BranchId = currentUser.BranchId;
                            Console.WriteLine($"‚úÖ [CategoryController] Create() - Asignado CompanyId: {category.CompanyId}, BranchId: {category.BranchId}");
                        }
                    }

                    await _categoryService.CreateCategoryAsync(category);
                    Console.WriteLine($"‚úÖ [CategoryController] Create() - Categor√≠a creada exitosamente: {category.Name}");
                    TempData["SuccessMessage"] = "Categor√≠a creada exitosamente.";
                    return RedirectToAction(nameof(Index));
                }
                else
                {
                    Console.WriteLine($"‚ùå [CategoryController] Create() - ModelState inv√°lido: {string.Join(", ", ModelState.Values.SelectMany(v => v.Errors).Select(e => e.ErrorMessage))}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå [CategoryController] Create() - Error: {ex.Message}");
                Console.WriteLine($"üîç [CategoryController] Create() - StackTrace: {ex.StackTrace}");
                TempData["ErrorMessage"] = "Error al crear la categor√≠a.";
            }
            
            return RedirectToAction(nameof(Index));
        }

        [HttpGet]
        public async Task<IActionResult> Edit(Guid id)
        {
            var category = await _categoryService.GetCategoryByIdAsync(id);
            if (category == null)
            {
                return NotFound();
            }
            return View(category);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Edit(Guid id, Category category)
        {
            if (id != category.Id)
            {
                return NotFound();
            }

            if (ModelState.IsValid)
            {
                try
                {
                    await _categoryService.UpdateCategoryAsync(id, category);
                    TempData["SuccessMessage"] = "Categor√≠a actualizada exitosamente.";
                    return RedirectToAction(nameof(Index));
                }
                catch (KeyNotFoundException)
                {
                    return NotFound();
                }
            }
            return View(category);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Delete(Guid id)
        {
            var exist = await _productService.GetByCategoryIdAsync(id);

            if (exist != null && exist.Any())
            {
                TempData["SuccessMessage"] = "La categor√≠a est√° asignada a uno o m√°s productos y no puede ser eliminada.";
                return RedirectToAction(nameof(Index));
            }

            var result = await _categoryService.DeleteCategoryAsync(id);
            if (!result)
            {
                return NotFound();
            }
            TempData["SuccessMessage"] = "Categor√≠a eliminada exitosamente.";
            return RedirectToAction(nameof(Index));
        }

        [HttpPost]
        public async Task<IActionResult> CreateAjax([FromForm] Category category)
        {
            try
            {
                Console.WriteLine("üîç [CategoryController] CreateAjax() - Iniciando creaci√≥n de categor√≠a via AJAX...");
                
                if (!ModelState.IsValid)
                {
                    Console.WriteLine($"‚ùå [CategoryController] CreateAjax() - ModelState inv√°lido: {string.Join(", ", ModelState.Values.SelectMany(v => v.Errors).Select(e => e.ErrorMessage))}");
                    return Json(new { success = false, message = "Datos inv√°lidos" });
                }

                // Obtener usuario actual y asignar CompanyId y BranchId
                var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);
                if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out Guid userId))
                {
                    var currentUser = await _areaService.GetCurrentUserWithAssignmentsAsync(userId);
                    if (currentUser != null)
                    {
                        category.CompanyId = currentUser.CompanyId;
                        category.BranchId = currentUser.BranchId;
                        Console.WriteLine($"‚úÖ [CategoryController] CreateAjax() - Asignado CompanyId: {category.CompanyId}, BranchId: {category.BranchId}");
                    }
                }

                var created = await _categoryService.CreateCategoryAsync(category);
                Console.WriteLine($"‚úÖ [CategoryController] CreateAjax() - Categor√≠a creada exitosamente: {created.Name}");
                return Json(new { success = true, data = new { id = created.Id, name = created.Name } });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå [CategoryController] CreateAjax() - Error: {ex.Message}");
                Console.WriteLine($"üîç [CategoryController] CreateAjax() - StackTrace: {ex.StackTrace}");
                return Json(new { success = false, message = "Error al crear la categor√≠a" });
            }
        }

        [HttpGet]
        public async Task<IActionResult> GetCategories()
        {
            try
            {
                Console.WriteLine("üîç [CategoryController] GetCategories() - Iniciando carga de categor√≠as del usuario actual...");
                var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);
                if (userIdClaim == null || !Guid.TryParse(userIdClaim.Value, out Guid userId))
                {
                    Console.WriteLine("‚ö†Ô∏è [CategoryController] GetCategories() - Usuario no autenticado");
                    return Json(new { success = false, message = "Usuario no autenticado", data = new List<object>() });
                }

                var currentUser = await _areaService.GetCurrentUserWithAssignmentsAsync(userId);
                if (currentUser == null)
                {
                    Console.WriteLine("‚ö†Ô∏è [CategoryController] GetCategories() - Usuario no encontrado");
                    return Json(new { success = false, message = "Usuario no encontrado", data = new List<object>() });
                }

                Console.WriteLine($"üë§ [CategoryController] GetCategories() - Usuario: {currentUser.FullName ?? currentUser.Email}");
                Console.WriteLine($"üè¢ [CategoryController] GetCategories() - CompanyId: {currentUser.CompanyId}");
                Console.WriteLine($"üè™ [CategoryController] GetCategories() - BranchId: {currentUser.BranchId}");

                var categories = await _categoryService.GetActiveCategoriesByCompanyAndBranchAsync(
                    currentUser.CompanyId.Value, currentUser.BranchId.Value);

                Console.WriteLine($"üìä [CategoryController] GetCategories() - Total categor√≠as filtradas: {categories.Count()}");
                
                var data = categories.Select(c => new { id = c.Id, name = c.Name }).ToList();
                Console.WriteLine($"‚úÖ [CategoryController] GetCategories() - Enviando {data.Count} categor√≠as");
                
                return Json(new { success = true, data });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå [CategoryController] GetCategories() - Error: {ex.Message}");
                Console.WriteLine($"üîç [CategoryController] GetCategories() - StackTrace: {ex.StackTrace}");
                return Json(new { success = false, message = $"Error al cargar categor√≠as: {ex.Message}", data = new List<object>() });
            }
        }

        [HttpGet]
        public async Task<IActionResult> GetCompanies()
        {
            try
            {
                Console.WriteLine("üîç [CategoryController] GetCompanies() - Iniciando carga de compa√±√≠a del usuario actual...");
                var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);
                if (userIdClaim == null || !Guid.TryParse(userIdClaim.Value, out Guid userId))
                {
                    Console.WriteLine("‚ö†Ô∏è [CategoryController] GetCompanies() - Usuario no autenticado");
                    return Json(new { success = false, message = "Usuario no autenticado", data = new List<object>() });
                }

                var currentUser = await _areaService.GetCurrentUserWithAssignmentsAsync(userId);
                if (currentUser == null)
                {
                    Console.WriteLine("‚ö†Ô∏è [CategoryController] GetCompanies() - Usuario no encontrado");
                    return Json(new { success = false, message = "Usuario no encontrado", data = new List<object>() });
                }

                if (!currentUser.CompanyId.HasValue)
                {
                    Console.WriteLine("‚ö†Ô∏è [CategoryController] GetCompanies() - Usuario no tiene compa√±√≠a asignada");
                    return Json(new { success = false, message = "Usuario no tiene compa√±√≠a asignada", data = new List<object>() });
                }

                var company = await _companyService.GetByIdAsync(currentUser.CompanyId.Value);
                if (company == null)
                {
                    Console.WriteLine("‚ö†Ô∏è [CategoryController] GetCompanies() - Compa√±√≠a no encontrada");
                    return Json(new { success = false, message = "Compa√±√≠a no encontrada", data = new List<object>() });
                }

                Console.WriteLine($"‚úÖ [CategoryController] GetCompanies() - Compa√±√≠a encontrada: {company.Name} (ID: {company.Id})");
                var data = new List<object> { new { id = company.Id, name = company.Name } };
                var response = new { success = true, data };
                Console.WriteLine($"üì§ [CategoryController] GetCompanies() - Enviando respuesta: {System.Text.Json.JsonSerializer.Serialize(response)}");
                return Json(response);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå [CategoryController] GetCompanies() - Error: {ex.Message}");
                Console.WriteLine($"üîç [CategoryController] GetCompanies() - StackTrace: {ex.StackTrace}");
                return Json(new { success = false, message = $"Error al cargar compa√±√≠a: {ex.Message}", data = new List<object>() });
            }
        }

        [HttpGet]
        public async Task<IActionResult> GetBranches()
        {
            try
            {
                Console.WriteLine("üîç [CategoryController] GetBranches() - Iniciando carga de sucursal del usuario actual...");
                var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);
                if (userIdClaim == null || !Guid.TryParse(userIdClaim.Value, out Guid userId))
                {
                    Console.WriteLine("‚ö†Ô∏è [CategoryController] GetBranches() - Usuario no autenticado");
                    return Json(new { success = false, message = "Usuario no autenticado", data = new List<object>() });
                }

                var currentUser = await _areaService.GetCurrentUserWithAssignmentsAsync(userId);
                if (currentUser == null)
                {
                    Console.WriteLine("‚ö†Ô∏è [CategoryController] GetBranches() - Usuario no encontrado");
                    return Json(new { success = false, message = "Usuario no encontrado", data = new List<object>() });
                }

                if (!currentUser.BranchId.HasValue)
                {
                    Console.WriteLine("‚ö†Ô∏è [CategoryController] GetBranches() - Usuario no tiene sucursal asignada");
                    return Json(new { success = false, message = "Usuario no tiene sucursal asignada", data = new List<object>() });
                }

                var branch = await _branchService.GetByIdAsync(currentUser.BranchId.Value);
                if (branch == null)
                {
                    Console.WriteLine("‚ö†Ô∏è [CategoryController] GetBranches() - Sucursal no encontrada");
                    return Json(new { success = false, message = "Sucursal no encontrada", data = new List<object>() });
                }

                Console.WriteLine($"‚úÖ [CategoryController] GetBranches() - Sucursal encontrada: {branch.Name} (ID: {branch.Id})");
                var data = new List<object> { new { id = branch.Id, name = branch.Name } };
                var response = new { success = true, data };
                Console.WriteLine($"üì§ [CategoryController] GetBranches() - Enviando respuesta: {System.Text.Json.JsonSerializer.Serialize(response)}");
                return Json(response);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå [CategoryController] GetBranches() - Error: {ex.Message}");
                Console.WriteLine($"üîç [CategoryController] GetBranches() - StackTrace: {ex.StackTrace}");
                return Json(new { success = false, message = $"Error al cargar sucursal: {ex.Message}", data = new List<object>() });
            }
        }
    }
} 