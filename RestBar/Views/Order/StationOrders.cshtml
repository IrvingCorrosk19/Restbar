@model List<RestBar.ViewModel.KitchenOrderViewModel>
@{
    ViewData["Title"] = ViewBag.StationTitle ?? "√ìrdenes de Estaci√≥n";
    Layout = "_KitchenLayout";
    
    var stationType = ViewBag.StationType?.ToString().ToLower() ?? "kitchen";
    var stationIcon = stationType switch
    {
        "kitchen" or "cocina" => "fas fa-fire",
        "bar" => "fas fa-glass-martini-alt",
        _ => "fas fa-utensils"
    };
    
    var stationName = ViewBag.StationTitle?.ToString() ?? "√ìrdenes de Estaci√≥n";
    var themeClass = stationType switch
    {
        "kitchen" or "cocina" => "kitchen-theme",
        "bar" => "bar-theme",
        _ => "kitchen-theme"
    };
}

<link href="~/css/modern-kitchen.css" rel="stylesheet" asp-append-version="true" />

<div class="modern-kitchen-container @themeClass">
    <div class="modern-kitchen-header">
        <div class="modern-kitchen-title">
            <div class="station-icon">
                <i class="@stationIcon"></i>
            </div>
            <div>
                <h1>@stationName</h1>
            <p>Pedidos pendientes de preparaci√≥n</p>
            </div>
        </div>
        <div class="modern-kitchen-controls">
            <button class="modern-kitchen-btn btn-primary" onclick="refreshOrdersList()">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <a href="/Home/Index" class="modern-kitchen-btn btn-secondary">
                <i class="fas fa-home"></i> Dashboard
            </a>
        </div>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; border: none; box-shadow: 0 10px 25px rgba(220, 53, 69, 0.3);">
            <i class="fas fa-exclamation-triangle"></i>
            @TempData["ErrorMessage"]
        </div>
    }

    <div class="modern-orders-grid">
        @if (!Model.Any())
        {
            <div class="modern-empty-state">
                <div class="modern-empty-icon">
                    <i class="@stationIcon"></i>
                </div>
                <h3>No hay √≥rdenes pendientes</h3>
                <p>Todas las √≥rdenes de @stationName.ToLower() est√°n completadas</p>
            </div>
        }
        else
        {
            @foreach (var order in Model)
            {
                <div class="modern-order-card" data-order-id="@order.OrderId">
                    <div class="modern-order-header">
                        <div class="modern-order-info">
                            <h3>Mesa @order.TableNumber</h3>
                            <span class="modern-order-time">@(order.OpenedAt?.ToString("HH:mm") ?? "N/A")</span>
                        </div>
                        <div class="modern-order-status">
                            <span class="modern-status-badge">
                                @(string.IsNullOrEmpty(order.OrderStatus) ? "En Proceso" : order.OrderStatus)
                            </span>
                        </div>
                    </div>

                    <div class="modern-order-items">
                        @foreach (var item in order.Items)
                        {
                            <div class="modern-order-item @(item.KitchenStatus.ToLower() == "ready" ? "ready" : "pending")" data-item-id="@item.ItemId">
                                <div class="modern-item-info">
                                    <h4>@item.ProductName</h4>
                                    <span class="modern-quantity">x@(item.Quantity)</span>
                                    @if (!string.IsNullOrEmpty(item.Notes))
                                    {
                                        <p class="modern-notes"><i class="fas fa-sticky-note"></i> @item.Notes</p>
                                    }
                                </div>
                                <div class="modern-item-status">
                                    <span class="modern-status-indicator @item.KitchenStatus.ToLower()">
                                        @item.KitchenStatus
                                    </span>
                                    <div class="modern-item-actions">
                                        <button class="modern-status-btn btn-ready" onclick="updateItemStatus('@item.ItemId', '@order.OrderId', 'Ready')" title="Marcar como listo">
                                        <i class="fas fa-check"></i>
                                    </button>
                                        <button class="modern-status-btn btn-cancel" onclick="deleteItem('@item.ItemId', '@order.OrderId')" title="Eliminar item">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="modern-order-summary">
                        <div class="modern-summary-stats">
                            <span class="modern-stat">
                                <i class="fas fa-clock"></i> @order.PendingItems pendiente(s)
                            </span>
                            <span class="modern-stat">
                                <i class="fas fa-check-circle"></i> @order.ReadyItems listo(s)
                            </span>
                        </div>
                        <div class="order-actions">
                            <button class="modern-complete-btn" onclick="completeOrder('@order.OrderId')">
                                <i class="fas fa-check-double"></i> Completar Orden
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

@section Scripts {
    <script src="~/js/order/signalr.js" asp-append-version="true"></script>
    <script src="https://unpkg.com/@@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <script>
        console.log('üîç [StationOrders] Script cargado - Iniciando...');
        console.log('üìã [StationOrders] Modelo recibido:', @Html.Raw(Json.Serialize(Model)));
        console.log('üìã [StationOrders] Total √≥rdenes en modelo:', @Model.Count);
        console.log('üìã [StationOrders] StationType:', '@ViewBag.StationType');
        console.log('üìã [StationOrders] StationTitle:', '@ViewBag.StationTitle');
        
        @if (Model.Any())
        {
            <text>
            console.log('‚úÖ [StationOrders] Hay √≥rdenes para mostrar');
            @foreach (var order in Model)
            {
                <text>
                console.log('üçΩÔ∏è [StationOrders] Orden:', '@order.OrderId', 'Mesa:', '@order.TableNumber', 'Items:', @order.Items.Count);
                @foreach (var item in order.Items)
                {
                    <text>
                    console.log('  üì¶ [StationOrders] Item:', '@item.ProductName', 'Estaci√≥n:', '@item.StationName', 'Estado:', '@item.KitchenStatus');
                    </text>
                }
                </text>
            }
            </text>
        }
        else
        {
            <text>
            console.log('‚ö†Ô∏è [StationOrders] No hay √≥rdenes para mostrar');
            </text>
        }

        // ‚úÖ NUEVO: Variable para almacenar la conexi√≥n SignalR (usar la global si existe)
        if (typeof signalRConnection === 'undefined') {
            window.signalRConnection = null;
        }
        const stationType = '@ViewBag.StationType';

        // ‚úÖ NUEVO: Inicializar SignalR para StationOrders
        async function initializeStationSignalR() {
            try {
                console.log('üîç [StationOrders] initializeStationSignalR() - Iniciando conexi√≥n SignalR...');
                
                window.signalRConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/orderHub")
                    .withAutomaticReconnect()
                    .build();

                // ‚úÖ NUEVO: Escuchar actualizaciones de items
                window.signalRConnection.on("OrderItemStatusChanged", (data) => {
                    console.log('üì° [StationOrders] OrderItemStatusChanged recibido:', data);
                    console.log('üîç [StationOrders] OrderItemStatusChanged - Par√°metros:', data);
                    
                    // ‚úÖ NUEVO: Mostrar notificaci√≥n detallada
                    if (data.Message) {
                        showNotification(data.Message, data.Type || 'info');
                    }
                    
                    console.log('üéØ [StationOrders] OrderItemStatusChanged - Llamando updateItemStatusInUI...');
                    updateItemStatusInUI(data.ItemId, data.Status);
                    console.log('‚úÖ [StationOrders] OrderItemStatusChanged - updateItemStatusInUI completado');
                });

                // ‚úÖ NUEVO: Escuchar nuevas √≥rdenes
                window.signalRConnection.on("NewOrder", (data) => {
                    console.log('üì° [StationOrders] NewOrder recibido:', data);
                    console.log('üìã [StationOrders] NewOrder - OrderId:', data.OrderId, 'TableNumber:', data.TableNumber);
                    
                    // ‚úÖ NUEVO: Mostrar notificaci√≥n detallada
                    if (data.Message) {
                        showNotification(data.Message, data.Type || 'success');
                    }
                    
                    // ‚úÖ CORREGIDO: No verificar Items, siempre actualizar ya que el backend ya filtr√≥ por estaci√≥n
                    showNewOrderNotification(data.OrderId, data.TableNumber);
                    refreshOrdersList(); // Actualizar la lista sin recargar
                });

                // ‚úÖ NUEVO: Escuchar actualizaciones de cocina
                window.signalRConnection.on("KitchenUpdate", () => {
                    console.log('üì° [StationOrders] KitchenUpdate recibido');
                    refreshOrdersList(); // Actualizar la lista sin recargar
                });

                // ‚úÖ NUEVO: Escuchar √≥rdenes completadas
                window.signalRConnection.on("OrderCompleted", (data) => {
                    console.log('üì° [StationOrders] OrderCompleted recibido:', data);
                    
                    // ‚úÖ NUEVO: Mostrar notificaci√≥n detallada
                    if (data.Message) {
                        showNotification(data.Message, data.Type || 'success');
                    }
                    
                    // Actualizar la lista para remover la orden completada
                    refreshOrdersList();
                });

                await window.signalRConnection.start();
                console.log('‚úÖ [StationOrders] SignalR conectado. ConnectionId:', window.signalRConnection.connectionId);

                // Unirse al grupo legacy "kitchen" ‚Äî recibe eventos de difusi√≥n general (NewOrder, OrderCompleted, etc.)
                await window.signalRConnection.invoke("JoinKitchenGroup");
                console.log('‚úÖ [StationOrders] Unido al grupo "kitchen" (difusi√≥n general)');

                // Unirse al grupo espec√≠fico de esta estaci√≥n ‚Äî recibe actualizaciones dirigidas (solo a este tipo)
                // Grupo: "station_kitchen", "station_bar", etc.
                if (stationType) {
                    await window.signalRConnection.invoke("JoinStationTypeGroup", stationType);
                    console.log(`‚úÖ [StationOrders] Unido al grupo "station_${stationType}" (notificaciones dirigidas)`);
                }

            } catch (error) {
                console.error('‚ùå [StationOrders] Error inicializando SignalR:', error);
            }
        }

        // ‚úÖ NUEVO: Actualizar estado de item en la UI sin recargar
        function updateItemStatusInUI(itemId, newStatus) {
            console.log('üîç ENTRADA: updateItemStatusInUI() - itemId:', itemId, 'newStatus:', newStatus);
            console.log('üîÑ [StationOrders] updateItemStatusInUI() - Iniciando actualizaci√≥n UI...');
            console.log('üìã [StationOrders] updateItemStatusInUI() - Par√°metros:', { itemId, newStatus });
            
            const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
            console.log('üîç [StationOrders] updateItemStatusInUI() - Elemento encontrado:', itemElement);
            
            if (itemElement) {
                // ‚úÖ NUEVO: Si el item se cancela, removerlo de la vista
                if (newStatus.toLowerCase() === 'cancelled') {
                    console.log('üóëÔ∏è [StationOrders] updateItemStatusInUI() - Removiendo item cancelado');
                    itemElement.remove();
                    
                    // Verificar si la orden queda vac√≠a
                    const orderElement = itemElement.closest('.modern-order-card');
                    const remainingItems = orderElement.querySelectorAll('.modern-order-item').length;
                    if (remainingItems === 0) {
                        console.log('üìã [StationOrders] updateItemStatusInUI() - Orden vac√≠a, removiendo orden completa');
                        orderElement.remove();
                    }
                } else {
                    // Actualizar indicador de estado
                    const statusIndicator = itemElement.querySelector('.modern-status-indicator');
                    if (statusIndicator) {
                        statusIndicator.textContent = newStatus;
                        statusIndicator.className = `modern-status-indicator ${newStatus.toLowerCase()}`;
                    }

                    // Actualizar clase del item
                    if (newStatus.toLowerCase() === 'ready') {
                        itemElement.classList.add('ready');
                        itemElement.classList.remove('pending');
                    } else {
                        itemElement.classList.add('pending');
                        itemElement.classList.remove('ready');
                    }

                    // Mostrar notificaci√≥n
                    const productName = itemElement.querySelector('.modern-item-info h4').textContent;
                    showItemReadyNotification(productName, newStatus);
                }
            }

            // Actualizar contadores de la orden
            updateOrderCounters();
        }

        // ‚úÖ NUEVO: Funci√≥n para mostrar notificaciones con SweetAlert
        function showNotification(message, type = 'info') {
            try {
                console.log('üîî [StationOrders] showNotification() - Mostrando notificaci√≥n:', { message, type });
                
                const iconMap = {
                    'success': 'success',
                    'error': 'error', 
                    'warning': 'warning',
                    'info': 'info',
                    'new_order': 'success',
                    'item_deleted': 'error',
                    'item_updated': 'success',
                    'table_status_changed': 'info'
                };
                
                const icon = iconMap[type] || 'info';
                
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Notificaci√≥n',
                        text: message,
                        icon: icon,
                        timer: 4000,
                        showConfirmButton: false,
                        toast: true,
                        position: 'top-end',
                        background: '#2d2d2d',
                        color: '#ffffff'
                    });
                } else {
                    console.log('üîî [StationOrders] SweetAlert no disponible, usando alert simple');
                    alert(message);
                }
            } catch (error) {
                console.error('‚ùå [StationOrders] showNotification() - Error:', error);
                alert(message); // Fallback
            }
        }

        // ‚úÖ NUEVO: Mostrar notificaci√≥n cuando un item est√° listo
        function showItemReadyNotification(productName, status) {
            if (status.toLowerCase() === 'ready') {
                // Usar SweetAlert si est√° disponible, sino alert simple
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Item Listo!',
                        text: `${productName} est√° listo para servir`,
                        icon: 'success',
                        timer: 3000,
                        showConfirmButton: false,
                        toast: true,
                        position: 'top-end'
                    });
                } else {
                    alert(`${productName} est√° listo!`);
                }
            }
        }

        // ‚úÖ NUEVO: Actualizar contadores de √≥rdenes
        function updateOrderCounters() {
            document.querySelectorAll('.modern-order-card').forEach(card => {
                const orderId = card.dataset.orderId;
                const items = Array.from(card.querySelectorAll('.modern-order-item'));
                
                const pendingItems = items.filter(item => item.classList.contains('pending')).length;
                const readyItems = items.filter(item => item.classList.contains('ready')).length;
                
                // Actualizar contadores
                const pendingCounter = card.querySelector('.modern-stat:first-child');
                const readyCounter = card.querySelector('.modern-stat:last-child');
                
                if (pendingCounter) {
                    pendingCounter.innerHTML = `<i class="fas fa-clock"></i> ${pendingItems} pendiente(s)`;
                }
                if (readyCounter) {
                    readyCounter.innerHTML = `<i class="fas fa-check-circle"></i> ${readyItems} listo(s)`;
                }
            });
        }

        // ‚úÖ NUEVO: Refrescar lista de √≥rdenes sin recargar p√°gina
        async function refreshOrdersList() {
            try {
                console.log('üîÑ [StationOrders] refreshOrdersList() - Actualizando lista...');
                
                const response = await fetch(`/Order/StationOrders?stationType=${stationType}`);
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newOrdersGrid = doc.querySelector('.modern-orders-grid');
                    
                    if (newOrdersGrid) {
                        const currentOrdersGrid = document.querySelector('.modern-orders-grid');
                        currentOrdersGrid.innerHTML = newOrdersGrid.innerHTML;
                        console.log('‚úÖ [StationOrders] Lista actualizada sin recargar p√°gina');
                    }
                }
            } catch (error) {
                console.error('‚ùå [StationOrders] Error actualizando lista:', error);
            }
        }

        // ‚úÖ NUEVO: Mostrar notificaci√≥n de nueva orden
        function showNewOrderNotification(orderId, tableNumber) {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: 'Nueva Orden!',
                    text: `Nueva orden recibida para Mesa ${tableNumber}`,
                    icon: 'info',
                    timer: 3000,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
            }
        }

        // ‚úÖ NUEVO: Funci√≥n para eliminar item
        window.deleteItem = function(itemId, orderId) {
            console.log('üîç ENTRADA: deleteItem() - itemId:', itemId, 'orderId:', orderId);
            try {
                console.log('üóëÔ∏è [StationOrders] deleteItem() - Iniciando eliminaci√≥n...');
                console.log('üìã [StationOrders] deleteItem() - Par√°metros:', { itemId, orderId });
                
                // Mostrar confirmaci√≥n
                if (confirm('¬øEst√°s seguro de que quieres eliminar este item?')) {
                    console.log('‚úÖ [StationOrders] deleteItem() - Usuario confirm√≥ eliminaci√≥n, llamando updateItemStatus...');
                    // Llamar a updateItemStatus con estado "Cancelled"
                    updateItemStatus(itemId, orderId, 'Cancelled');
                } else {
                    console.log('‚ùå [StationOrders] deleteItem() - Usuario cancel√≥ eliminaci√≥n');
                }
            } catch (error) {
                console.error('‚ùå [StationOrders] deleteItem() - Error:', error);
                alert('Error al eliminar el item: ' + error.message);
            }
        }

        // ‚úÖ MODIFICADO: Funci√≥n de actualizar estado sin recargar (GLOBAL)
        window.updateItemStatus = function(itemId, orderId, status) {
            console.log('üîç ENTRADA: updateItemStatus() - itemId:', itemId, 'orderId:', orderId, 'status:', status);
            try {
                console.log('üîç [StationOrders] updateItemStatus() - Iniciando actualizaci√≥n de estado...');
                console.log('üìã [StationOrders] updateItemStatus() - Par√°metros:', { itemId, orderId, status });
                console.log('üåê [StationOrders] updateItemStatus() - Enviando petici√≥n a /Order/UpdateItemStatus');
            
            fetch(`/Order/UpdateItemStatus`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    itemId: itemId,
                    orderId: orderId,
                    status: status
                })
            })
                .then(response => {
                    console.log('üì° [StationOrders] updateItemStatus() - Respuesta recibida:', response.status, response.statusText);
                    return response.json();
                })
            .then(data => {
                    console.log('üì° [StationOrders] updateItemStatus() - Datos recibidos:', data);
                if (data.success) {
                        console.log('‚úÖ [StationOrders] updateItemStatus() - Item actualizado exitosamente');
                        // ‚úÖ NUEVO: Actualizar UI directamente en lugar de recargar
                        updateItemStatusInUI(itemId, status);
                } else {
                        console.log('‚ùå [StationOrders] updateItemStatus() - Error en respuesta:', data.message);
                        alert('Error al actualizar el estado del item: ' + (data.message || 'Error desconocido'));
                }
            })
            .catch(error => {
                    console.error('‚ùå [StationOrders] updateItemStatus() - Error de conexi√≥n:', error);
                    alert('Error de conexi√≥n: ' + error.message);
            });
            } catch (error) {
                console.error('‚ùå [StationOrders] updateItemStatus() - Error:', error);
                alert('Error: ' + error.message);
            }
        }

        window.completeOrder = function(orderId) {
            
            
            if (confirm('¬øEst√°s seguro de que quieres marcar esta orden como completada?')) {
                fetch(`/Order/CompleteOrder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        orderId: orderId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        
                        location.reload();
                    } else {
                        
                        alert('Error al completar la orden');
                    }
                })
                .catch(error => {
                    
                    alert('Error de conexi√≥n');
                });
            }
        }

        // ‚úÖ NUEVO: Inicializar SignalR cuando se carga la p√°gina
        // ‚úÖ NUEVO: Funci√≥n para inicializar contadores al cargar la p√°gina
        function initializeOrderCounters() {
            console.log('üîç [StationOrders] initializeOrderCounters() - Inicializando contadores...');
            
            // Actualizar contadores inmediatamente al cargar
            updateOrderCounters();
            
            // Actualizar contadores cada 5 segundos para mantener sincronizaci√≥n
            setInterval(updateOrderCounters, 5000);
            
            console.log('‚úÖ [StationOrders] initializeOrderCounters() - Contadores inicializados');
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [StationOrders] DOM cargado - Inicializando SignalR...');
            initializeStationSignalR();
            initializeOrderCounters(); // ‚úÖ NUEVO: Inicializar contadores
        });

        // Limpiar conexi√≥n SignalR cuando se cierra la p√°gina
        window.addEventListener('beforeunload', function() {
            if (window.signalRConnection) {
                if (stationType) {
                    window.signalRConnection.invoke("LeaveStationTypeGroup", stationType).catch(() => {});
                }
                window.signalRConnection.invoke("LeaveKitchenGroup").catch(() => {});
                window.signalRConnection.stop();
            }
        });
    </script>
}
