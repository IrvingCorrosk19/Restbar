@model IEnumerable<RestBar.Models.Company>
@{
    ViewData["Title"] = "Compañías";
}

<div class="container mt-4">
    <h2 class="text-center mb-4">Gestión de Compañías</h2>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <input type="text" id="searchName" class="form-control d-inline-block w-auto" placeholder="Buscar por nombre..." style="min-width:200px;">
            <input type="text" id="searchLegalId" class="form-control d-inline-block w-auto ms-2" placeholder="Buscar por Legal ID..." style="min-width:200px;">
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCreateCompany">
            <i class="fas fa-plus me-2"></i>Nueva Compañía
        </button>
    </div>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="companyCards">
        @foreach (var company in Model)
        {
            <div class="col company-card" data-name="@company.Name" data-legalid="@company.LegalId">
                <div class="card h-100 card-elevated card-indigo">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-building fa-2x text-indigo me-3"></i>
                            <h5 class="card-title mb-0">@company.Name</h5>
                        </div>
                        <p class="mb-1"><strong>Legal ID:</strong> @company.LegalId</p>
                        <p class="mb-1"><strong>Creada:</strong> @(company.CreatedAt.HasValue ? company.CreatedAt.Value.ToString("dd/MM/yyyy") : "Sin fecha")</p>
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-indigo btn-sm" onclick="openEditModal('@company.Id')"><i class="fas fa-edit me-1"></i>Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCompany('@company.Id')"><i class="fas fa-trash me-1"></i>Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Modal Crear Compañía -->
<div class="modal fade" id="modalCreateCompany" tabindex="-1" aria-labelledby="modalCreateCompanyLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formCreateCompany">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCreateCompanyLabel">Nueva Compañía</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="createName" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="createName" name="Name" required>
                    </div>
                    <div class="mb-3">
                        <label for="createLegalId" class="form-label">Legal ID</label>
                        <input type="text" class="form-control" id="createLegalId" name="LegalId">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Compañía -->
<div class="modal fade" id="modalEditCompany" tabindex="-1" aria-labelledby="modalEditCompanyLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formEditCompany">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditCompanyLabel">Editar Compañía</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId" name="Id">
                    <div class="mb-3">
                        <label for="editName" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="editName" name="Name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editLegalId" class="form-label">Legal ID</label>
                        <input type="text" class="form-control" id="editLegalId" name="LegalId">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-indigo">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Filtro por nombre y legalId
        $("#searchName, #searchLegalId").on("input", function () {
            var name = $("#searchName").val().toLowerCase();
            var legalId = $("#searchLegalId").val().toLowerCase();
            $(".company-card").each(function () {
                var cardName = $(this).data("name").toLowerCase();
                var cardLegalId = $(this).data("legalid").toLowerCase();
                var show = true;
                if (name && !cardName.includes(name)) show = false;
                if (legalId && !cardLegalId.includes(legalId)) show = false;
                $(this).toggle(show);
            });
        });

        // Crear compañía
        $("#formCreateCompany").on("submit", function (e) {
            e.preventDefault();
            var data = {
                Name: $("#createName").val(),
                LegalId: $("#createLegalId").val()
            };
            Swal.fire({
                title: 'Creando compañía...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
            $.ajax({
                url: '/Company/Create',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (res) {
                    if (res.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '¡Compañía creada correctamente!',
                            showConfirmButton: false,
                            timer: 1200
                        }).then(() => location.reload());
                    } else {
                        Swal.fire('Error', res.message, 'error');
                    }
                },
                error: function () {
                    Swal.fire('Error', 'No se pudo crear la compañía', 'error');
                }
            });
        });

        // Abrir modal de edición y cargar datos
        window.openEditModal = function (id) {
            $.get('/Company/Get', { id: id }, function (res) {
                if (res.success) {
                    var c = res.data;
                    $("#editId").val(c.id);
                    $("#editName").val(c.name);
                    $("#editLegalId").val(c.legalId);
                    $("#modalEditCompany").modal('show');
                } else {
                    Swal.fire('Error', res.message, 'error');
                }
            });
        };

        // Guardar cambios de edición
        $("#formEditCompany").on("submit", function (e) {
            e.preventDefault();
            var data = {
                Id: $("#editId").val(),
                Name: $("#editName").val(),
                LegalId: $("#editLegalId").val()
            };
            Swal.fire({
                title: 'Guardando cambios...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
            $.ajax({
                url: '/Company/Edit?id=' + data.Id,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (res) {
                    if (res.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '¡Compañía editada correctamente!',
                            showConfirmButton: false,
                            timer: 1200
                        }).then(() => location.reload());
                    } else {
                        Swal.fire('Error', res.message, 'error');
                    }
                },
                error: function () {
                    Swal.fire('Error', 'No se pudo editar la compañía', 'error');
                }
            });
        });

        // Eliminar compañía
        window.deleteCompany = function (id) {
            Swal.fire({
                title: '¿Eliminar compañía?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#6f42c1'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Eliminando compañía...',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });
                    $.ajax({
                        url: '/Company/Delete?id=' + id,
                        type: 'DELETE',
                        success: function (res) {
                            if (res.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: '¡Compañía eliminada correctamente!',
                                    showConfirmButton: false,
                                    timer: 1200
                                }).then(() => location.reload());
                            } else {
                                Swal.fire('Error', res.message, 'error');
                            }
                        },
                        error: function () {
                            Swal.fire('Error', 'No se pudo eliminar la compañía', 'error');
                        }
                    });
                }
            });
        };
    </script>
}

@section Styles {
    <style>
        .card-elevated {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
        }
        .card-elevated:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        .card-indigo {
            border-left: 5px solid #6610f2;
        }
        .btn-indigo {
            background-color: #6610f2;
            border-color: #6610f2;
            color: white;
        }
        .btn-indigo:hover {
            background-color: #520dc2;
            border-color: #520dc2;
            color: white;
        }
        .text-indigo {
            color: #6610f2;
        }
    </style>
} 